<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Kubernetes | 一缕书香一缕魂</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="Kubernetes">
    <meta name="generator" content="Hugo 0.80.0" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    

  
  
    <link rel="stylesheet" href="/ananke/dist/main.css_5c99d70a7725bacd4c701e995b969fea.css" >
  




    
      

    

    
    
    <meta property="og:title" content="Kubernetes" />
<meta property="og:description" content="Kubernetes" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://nijian.life/software/platform/kubernetes/" />
<meta property="article:published_time" content="2021-01-01T10:58:08-04:00" />
<meta property="article:modified_time" content="2021-01-01T10:58:08-04:00" /><meta property="og:site_name" content="一缕书香一缕魂" />
<meta itemprop="name" content="Kubernetes">
<meta itemprop="description" content="Kubernetes">
<meta itemprop="datePublished" content="2021-01-01T10:58:08-04:00" />
<meta itemprop="dateModified" content="2021-01-01T10:58:08-04:00" />
<meta itemprop="wordCount" content="561">



<meta itemprop="keywords" content="平台," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Kubernetes"/>
<meta name="twitter:description" content="Kubernetes"/>

	
  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  
  
  <header class="cover bg-top" style="background-image: url('http://nijian.life/images/x1.png');">
    <div class="pb3-m pb6-l bg-black-60">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        一缕书香一缕魂
      
    </a>
    <div class="flex-l items-center">
      

      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/software/" title="技术文章 page">
              技术文章
            </a>
          </li>
          
        </ul>
      
      















    </div>
  </div>
</nav>

      <div class="tc-l pv6 ph3 ph4-ns">
        
          <h1 class="f2 f1-l fw2 white-90 mb0 lh-title">Kubernetes</h1>
          
            <h2 class="fw1 f5 f3-l white-80 measure-wide-l center lh-copy mt3 mb4">
              Kubernetes
            </h2>
          
        
      </div>
    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked">
          
        技术文章
      </aside>
      




  <div id="sharing" class="mt3">

    
    <a href="https://www.facebook.com/sharer.php?u=http://nijian.life/software/platform/kubernetes/" class="facebook no-underline" aria-label="share on Facebook">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765,50.32h6.744V33.998h4.499l0.596-5.624h-5.095  l0.007-2.816c0-1.466,0.14-2.253,2.244-2.253h2.812V17.68h-4.5c-5.405,0-7.307,2.729-7.307,7.317v3.377h-3.369v5.625h3.369V50.32z   M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;"/></svg>

    </a>

    
    
    <a href="https://twitter.com/share?url=http://nijian.life/software/platform/kubernetes/&amp;text=Kubernetes" class="twitter no-underline" aria-label="share on Twitter">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

    </a>

    
    <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http://nijian.life/software/platform/kubernetes/&amp;title=Kubernetes" class="linkedin no-underline" aria-label="share on LinkedIn">
      <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

    </a>
  </div>


      <h1 class="f1 athelas mt3 mb1">Kubernetes</h1>
      
      
      <time class="f6 mv4 dib tracked" datetime="2021-01-01T10:58:08-04:00">January 1, 2021</time>

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><h2 id="简介">简介</h2>
<p>Kubernetes 是一个可移植，可扩展的开源平台，用于管理容器化的负载和服务。容器技术非常有利于实现声明式配置和运行自动化。</p>
<blockquote>
<p>本文基于 ubuntu 20.4 。</p>
</blockquote>
<p><strong>部署技术的演化</strong></p>
<p><img src="/images/container_evolution.svg" alt="部署演化图"></p>
<p>传统部署是基于物理机服务器，当一台物理机服务器上部署并运行了多个应用程序实例时，物理机的资源（ 例如 CPU ， Memory ）无法在这些应用程序实例之间进行有效的分配和控制。例如，在某一个时刻，某一个应用程序实例占用了物理机的大部分资源，而其他的应用程序实例则因缺少资源运行缓慢。也正是由于这个原因，应用程序的伸缩性无法得到可靠的支持。</p>
<p>虚拟化部署通过引入虚拟机方案，解决了传统部署在资源分配和伸缩性方面的困扰。一台物理机上可以运行多个虚拟机，应用程序部署在虚拟机中。这些虚拟机运行在硬件虚拟化层之上，所使用的资源是可以进行分配和控制的，</p>
<p>容器化部署是虚拟化部署的进一步发展，容器与虚拟机类似，它拥有自己的文件系统、独立的进程空间、以及共享的物理机资源，不同之处在于，容器之间共享操作系统，且不需要硬件虚拟化层。相比于虚拟机，容器更加轻量化。</p>
<p><strong>容器技术的特性</strong></p>
<p>使用容器技术可以带来：</p>
<ul>
<li>Agile application creation and deployment</li>
</ul>
<p><strong>Kubernetes</strong></p>
<p>Kubernetes 提供了以下功能：</p>
<ul>
<li>服务发现和负载均衡</li>
<li>存储编排</li>
<li>自动伸缩</li>
<li>自愈</li>
<li>敏感信息和配置管理</li>
</ul>
<h2 id="术语">术语</h2>
<table>
<thead>
<tr>
<th>术语</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>node</td>
<td>运行容器化应用程序的工作节点，每个 k8s 集群至少包含一个工作节点。</td>
</tr>
<tr>
<td>deployment</td>
<td>负责管理集群中一个可复制的应用程序。</td>
</tr>
<tr>
<td>service</td>
<td>负责管理集群中一个可复制的应用程序。</td>
</tr>
<tr>
<td>pod</td>
<td>一个 pod 代表了集群中一组正在运行的容器。 pod 是在运行应用程序时动态创建的。</td>
</tr>
<tr>
<td>service</td>
<td>本f。</td>
</tr>
<tr>
<td>apiserver</td>
<td>。</td>
</tr>
<tr>
<td>SCTP</td>
<td>。</td>
</tr>
<tr>
<td>Kubernetes API</td>
<td>。</td>
</tr>
<tr>
<td>DaemonSet</td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="本地环境">本地环境</h2>
<p>minikube 是一个用于运行本地 kubernetes 的工具。为了使本地环境更加干净，以下使用了 vmware 。</p>
<p><strong>安装 vmware player</strong></p>
<pre><code>sudo apt update

sudo apt install build-essential linux-headers-generic

wget --user-agent=&quot;Mozilla/5.0 (X11; Linux x86_64; rv:60.0) Gecko/20100101 Firefox/60.0&quot; https://www.vmware.com/go/getplayer-linux

chmod +x getplayer-linux

sudo ./getplayer-linux --required --eulas-agreed
</code></pre>
<p>如果遇到 Could not open /dev/vmmon 的问题</p>
<blockquote>
<p>On Linux host with secure mode enabled, it is not allowed to load any unsigned drivers. Due to this, VMware drivers, such as vmmon and vmnet, are not able to be loaded which prevents virtual machine to power on.</p>
</blockquote>
<pre><code>openssl req -new -x509 -newkey rsa:2048 -keyout MOK.priv -outform DER -out MOK.der -nodes -days 36500 -subj &quot;/CN=VMWare&quot;

sudo /usr/src/linux-headers-`uname -r`/scripts/sign-file sha256 ./MOK.priv ./MOK.der $(modinfo -n vmmon)

sudo /usr/src/linux-headers-`uname -r`/scripts/sign-file sha256 ./MOK.priv ./MOK.der $(modinfo -n vmnet)

sudo mokutil --import MOK.der

sudo shutdown -r now
</code></pre>
<blockquote>
<p>At first I didn&rsquo;t get a blue screen background after restart, but that was because my secure boot was set to boot from grubx64.efi but not shimx64.efi. But after I changed it to shim I got the MOK manager asking me to enroll this key</p>
</blockquote>
<p><strong>安装 minikube</strong></p>
<pre><code>curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64

sudo install minikube-linux-amd64 /usr/local/bin/minikube
</code></pre>
<p>minikube 运行需要依赖于一个容器的驱动，例如 docker 。设置缺省的 driver ：</p>
<pre><code>minikube config set driver docker
</code></pre>
<p>启动时指定 kubernetes 版本</p>
<pre><code>minikube start --kubernetes-version v1.16.3 
</code></pre>
<blockquote>
<p>如果无法访问 k8s.gcr.io 等镜像库，可以通过 minikube ssh 命令进入，安装 docker 并从有效的镜像库拉取对应版本，并在本地打标签。</p>
</blockquote>
<p>进入 dashboard</p>
<pre><code>minikube dashboard
</code></pre>
<blockquote>
<p>如果本地已安装其他版本的 cluster ，可参考该命令给出的提示进行操作，例如，删除已安装 cluster ，或创建一个新的 cluster 。</p>
</blockquote>
<p>启动</p>
<pre><code>minikube start
--base-image=&quot;kicbase/...&quot;

--image-mirror-country=&quot;cn&quot;

--image-repository=&quot;registry.cn-hangzhou.aliyuncs.com/google_containers&quot;
</code></pre>
<p><strong>安装 kubectl</strong></p>
<pre><code>curl -LO &quot;https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl&quot;

sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl

kubectl version --client
</code></pre>
<h2 id="kubectl-常用命令">kubectl 常用命令</h2>
<p>kubectl 是一个命令行工具，用于控制 kubernetes 集群。</p>
<pre><code>kubectl [command] [TYPE] [NAME] [flags]
</code></pre>
<p>访问多个集群</p>
<h2 id="概念">概念</h2>
<ul>
<li>application workload</li>
<li>control plane</li>
</ul>
<h2 id="kubernetes-控制面组件-control-plane-components-">Kubernetes 控制面组件（ Control Plane Components ）</h2>
<ul>
<li>API Server （ kube-apiserver ）</li>
<li>etcd</li>
</ul>
<h2 id="kubernetes-api">Kubernetes API</h2>
<p>Kubernetes API 用于查询和管理 Kubernetes Objects 的<strong>状态（ state ）</strong>。</p>
<h2 id="kubernetes-objects">Kubernetes Objects</h2>
<ul>
<li>Pods</li>
<li>Namespaces</li>
<li>ConfigMaps</li>
<li>Events</li>
</ul>
<h2 id="工作负载-workloads-">工作负载（ Workloads ）</h2>
<p>工作负载是指在 Kubernetes 中运行的应用程序，这些应用程序运行在一组 Pod 中，而每一个 Pod 又代表着一组运行中的容器（ container ）。</p>
<p>本节描述 Pod 相关的概念，以及确保 Pod 在 Kubernetes 中可控运行的相关资源（ workload resource ）。</p>
<blockquote>
<p>Kubernetes 不会直接控制 Pod 的运行，而是通过资源配置声明，由 controller 控制完成。这正是 Kubernetes 进行容器声明式自动化管理的基本特征。</p>
</blockquote>
<h2 id="service">service</h2>
<p><strong>kubelet</strong></p>
<p>kubelet 是运行在每个工作节点（ node ）上的代理，负责把工作节点在 Kubernetes API server 上进行注册。</p>
<p>除了注册工作节点外， kubelet 的工作还包括确保容器（ 例如 pod ）健康地运行。这些容器通常使用 PodSpec （ YAML 或 JSON object ） 来描述。 PocSpec 的来源如下：</p>
<ul>
<li>通常来自于 Kubernetes API server</li>
<li>命令行指定的文件路径</li>
<li>命令行指定的 HTTP endpoint</li>
<li>kubelet HTTP 服务</li>
</ul>
<p><strong>kube-apiserver</strong></p>
<p>Kubernetes API server 用于校验和配置 api 对象（ objects ），例如， pods ， services ， replicationcontrollers 等。</p>
<p><strong>kube-proxy</strong></p>
<p>kube-proxy 是运行在每个工作节点（ node ）上的网络代理，它代理那些定义在 Kubernetes API 中的服务（ service ），即负责对 TCP 、 UDP 、 及 SCTP 流（ stream ）进行转发（ forwarding ），并以轮询（ round-robin ）的方式转发至一组后端。</p>
<p>服务（ service ）的 cluster IP 和 Port 是由 kube-proxy 公开出去的，这些 cluster IP 也可以通过 cluster DNS （例如， CoreDNS ）提供一个集群内部的服务名。如果要配置 kube-proxy ，必须通过 apiserver API 创建一个相应的服务（ service ）。</p>
<p>kube-proxy 提供的主要功能如下：</p>
<ul>
<li>清除 iptables 和 ipvs 规则</li>
<li>指定 Azure container registry configuration 文件</li>
<li>在指定 IP 地址监听（缺省值 IPv4 : 0.0.0.0 ， IPv6 : &lsquo;::&rsquo; ）</li>
<li>指定健康检查的 IP 和端口（缺省值 IPv4 : 0.0.0.0:10256 ， IPv6 : &lsquo;[::]:10256&rsquo; ）</li>
<li>主机名覆盖</li>
<li>kubeconfig 文件地址配置</li>
<li>指定 Kubernetes API server 的地址</li>
<li>指定代理模式，包括 userspace ， iptables （缺省值）， ipvs 等</li>
<li>生成配置文件</li>
</ul>
<p>kube-proxy 首先会operating system packet filtering layer</p>
<p><strong>用户空间代理模式（ user space proxy mode ）</strong></p>
<p><strong>iptables 代理模式</strong></p>
<p>network address translation (NAT)</p>
<h2 id="kubernetes-开发">kubernetes 开发</h2>
<p>如果需要编写直接访问 kubernetes API 的代码，或者向 kubernetes 社区贡献代码，可以参考以下内容。</p>
<p><strong>在本地 OS/shell 环境下构建 kubernetes</strong></p>
<pre><code>sudo apt update

sudo apt install build-essential
</code></pre>
<ul class="pa0">
  
   <li class="list">
     <a href="/tags/%E5%B9%B3%E5%8F%B0" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">平台</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l"><div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">这是什么 software</p>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#简介">简介</a></li>
    <li><a href="#术语">术语</a></li>
    <li><a href="#本地环境">本地环境</a></li>
    <li><a href="#kubectl-常用命令">kubectl 常用命令</a></li>
    <li><a href="#概念">概念</a></li>
    <li><a href="#kubernetes-控制面组件-control-plane-components-">Kubernetes 控制面组件（ Control Plane Components ）</a></li>
    <li><a href="#kubernetes-api">Kubernetes API</a></li>
    <li><a href="#kubernetes-objects">Kubernetes Objects</a></li>
    <li><a href="#工作负载-workloads-">工作负载（ Workloads ）</a></li>
    <li><a href="#service">service</a></li>
    <li><a href="#kubernetes-开发">kubernetes 开发</a></li>
  </ul>
</nav>
  </div>




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="http://nijian.life" >
    &copy;  一缕书香一缕魂 2021 
  </a>
    <div>














</div>
  </div>
</footer>

  </body>
</html>
