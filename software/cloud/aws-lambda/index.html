<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>AWS Lambda | 一缕书香一缕魂</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="AWS Lambda">
    <meta name="generator" content="Hugo 0.80.0" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    

  
  
    <link rel="stylesheet" href="/ananke/dist/main.css_5c99d70a7725bacd4c701e995b969fea.css" >
  




    
      

    

    
    
    <meta property="og:title" content="AWS Lambda" />
<meta property="og:description" content="AWS Lambda" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://nijian.life/software/cloud/aws-lambda/" />
<meta property="article:published_time" content="2021-06-05T15:00:18+08:00" />
<meta property="article:modified_time" content="2021-06-05T15:00:18+08:00" /><meta property="og:site_name" content="一缕书香一缕魂" />
<meta itemprop="name" content="AWS Lambda">
<meta itemprop="description" content="AWS Lambda">
<meta itemprop="datePublished" content="2021-06-05T15:00:18+08:00" />
<meta itemprop="dateModified" content="2021-06-05T15:00:18+08:00" />
<meta itemprop="wordCount" content="1124">



<meta itemprop="keywords" content="软件,AWS,Lambda," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="AWS Lambda"/>
<meta name="twitter:description" content="AWS Lambda"/>

	
  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        一缕书香一缕魂
      
    </a>
    <div class="flex-l items-center">
      

      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/intro/" title="个人简介 page">
              个人简介
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="/software/" title="技术文章 page">
              技术文章
            </a>
          </li>
          
        </ul>
      
      















    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked">
          
        技术文章
      </aside>
      




  <div id="sharing" class="mt3">

    
    <a href="https://www.facebook.com/sharer.php?u=http://nijian.life/software/cloud/aws-lambda/" class="facebook no-underline" aria-label="share on Facebook">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765,50.32h6.744V33.998h4.499l0.596-5.624h-5.095  l0.007-2.816c0-1.466,0.14-2.253,2.244-2.253h2.812V17.68h-4.5c-5.405,0-7.307,2.729-7.307,7.317v3.377h-3.369v5.625h3.369V50.32z   M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;"/></svg>

    </a>

    
    
    <a href="https://twitter.com/share?url=http://nijian.life/software/cloud/aws-lambda/&amp;text=AWS%20Lambda" class="twitter no-underline" aria-label="share on Twitter">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

    </a>

    
    <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http://nijian.life/software/cloud/aws-lambda/&amp;title=AWS%20Lambda" class="linkedin no-underline" aria-label="share on LinkedIn">
      <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

    </a>
  </div>


      <h1 class="f1 athelas mt3 mb1">AWS Lambda</h1>
      
      
      <time class="f6 mv4 dib tracked" datetime="2021-06-05T15:00:18+08:00">June 5, 2021</time>

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><h2 id="简介">简介</h2>
<p>AWS Lambda 是 AWS 提供的一种<a href="http://nijian.life/software/cloud/compute/"><strong>计算服务</strong></a>，服务内容包括：</p>
<ul>
<li>提供高可用性计算基础设施</li>
<li>提供计算资源的自动管理任务，包括服务器和操作系统维护、容量配置和自动伸缩、代码监控和日志记录等</li>
<li>仅在需要时运行 Lambda Function ，并根据计算时间计费</li>
</ul>
<blockquote>
<p>Lambda Function 是部署在 Lambda 服务上的程序包。仅在<strong>需要</strong>时运行 Lambda Function ，并根据计算时间计费，这项服务内容可以极大地降低云平台的使用成本，事实上，这也是 Lambda 服务的核心价值。</p>
</blockquote>
<p>使用 Lambda 服务需要引入一些新的编程思想，例如， Lambda Function 应该尽可能做到原子化和无状态计算。</p>
<blockquote>
<p>原子化意味着高度内聚。原子化的本质是尽量避免对<strong>外部服务</strong>的依赖。依赖通常是使应用系统趋于复杂的重要因素。例如，当同步依赖的外部服务需要长时间运行， Lambda Function 无法快速销毁，这可能破坏 Lambda 服务为应用带来的好处。无状态计算则是指在计算期间不涉及中间数据和计算任务的状态，这使 Lambda Function 的计算变得简单而纯粹。</p>
</blockquote>
<h2 id="术语">术语</h2>
<table>
<thead>
<tr>
<th>术语</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>layer</td>
<td>一个层是一个 .zip 文件（不适用于镜像），使用层技术，可以使部署包尽可能地小，因为部署包依赖的库可以通过一个新的层提供</td>
</tr>
<tr>
<td>runtime</td>
<td>在 Lambda 运行环境中工作的一个编程语言相关的环境，负责转发调用事件，上下文信息，以及最终的响应</td>
</tr>
<tr>
<td>handler</td>
<td>函数代码中由 Lambda 调用并开始执行的方法</td>
</tr>
<tr>
<td>code signing</td>
<td>代码签名</td>
</tr>
<tr>
<td>execution role</td>
<td>授权 Lambda 函数去访问 AWS 服务和资源的 IAM 角色（ AWS Identity and Access Management (IAM) role ）</td>
</tr>
<tr>
<td>unpublished version</td>
<td>未发布的版本，当函数更新时，会发生相应的变化</td>
</tr>
<tr>
<td>published versions</td>
<td>已发布的版本，是函数的一个快照，不会发生变化</td>
</tr>
<tr>
<td>aliases</td>
<td>函数别名，可以设置使之对应于一个版本</td>
</tr>
<tr>
<td>ARN</td>
<td>Amazon Resource Name ， 例如，execution role ARN 的样式为 arn:aws:iam::your-account-id:role/execution_role</td>
</tr>
</tbody>
</table>
<h2 id="常用命令-aws-cli">常用命令 AWS CLI</h2>
<p>卸载 AWS CLI version 1</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo rm -rf /usr/local/aws

sudo rm /usr/local/bin/aws
</code></pre></div><p>安装 AWS CLI version 2</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl <span style="color:#e6db74">&#34;https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip&#34;</span> -o <span style="color:#e6db74">&#34;awscliv2.zip&#34;</span>

unzip awscliv2.zip

sudo ./aws/install
</code></pre></div><p>创建 Lambda 函数</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">aws lambda create-function <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --function-name my-function <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --runtime go1.x <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --zip-file fileb://my-function.zip <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --handler main <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --role arn:aws:iam::your-account-id:role/execution_role
</code></pre></div><p>更新 Lambda 函数代码</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">aws lambda update-function-code <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --function-name  my-function <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --zip-file fileb://my-function.zip
</code></pre></div><blockquote>
<p>注意，上述命令更新的是 unpublished ( $LATEST ) version 。可以通过 &ndash;revision-id 指定某个特定的 unpublished 版本。</p>
</blockquote>
<p>创建别名</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">aws lambda create-alias <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --function-name my-function <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --description <span style="color:#e6db74">&#34;alias for live version of function&#34;</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --function-version <span style="color:#ae81ff">1</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --name LIVE
</code></pre></div><blockquote>
<p>别名可以使 Lambda 函数客户端的代码或配置保持稳定。</p>
</blockquote>
<p>发布一个正式版本</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">aws lambda publish-version <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    --function-name my-function
</code></pre></div><h2 id="lambda-运行环境">Lambda 运行环境</h2>
<figure>
    <img src="/images/aws-lambda-execution-environment.png"/> 
</figure>

<h2 id="lambda-运行环境生命周期">Lambda 运行环境生命周期</h2>
<figure>
    <img src="/images/aws-lambda-execution-environment-lifecycle.png"/> 
</figure>

<p>三个阶段：</p>
<ul>
<li>Init</li>
</ul>
<blockquote>
<p>第一次调用时触发（或根据并行预配置）。基本过程是，基于配置创建运行环境，下载函数及各层代码，初始化扩展和运行时，运行函数初始化代码。</p>
</blockquote>
<ul>
<li>Invoke</li>
</ul>
<blockquote>
<p>Lambda 调用函数 Handler。</p>
</blockquote>
<ul>
<li>Shutdown</li>
</ul>
<blockquote>
<p>一段时间没有收到任何调用后触发。</p>
</blockquote>
<h2 id="lambda-函数发布">Lambda 函数发布</h2>
<p>部署包有两种形式：</p>
<ul>
<li>容器镜像 （ container image ）</li>
<li>.zip 文件</li>
</ul>
<h3 id="容器镜像">容器镜像</h3>
<p>一般使用 Docker CLI 把函数代码和相关依赖打包成一个镜像，也可以使用 AWS Serverless Application Model （ AWS SAM ）来创建。</p>
<p>AWS 提供了一些基础镜像，这些基础镜像包含了相关编程语言的运行时，以及支持镜像在 AWS Lambda 中运行的组件，例如，运行时接口客户端 （ RIC ， runtime interface clients ，用于管理 Lambda 和函数代码之间的交互）。</p>
<p>镜像创建后，使用 AWS CLI 上传至 Amazon Elastic Container Registry （ Amazon ECR ）。</p>
<blockquote>
<p>当前， ECR 存储会产生费用。对于私有镜像库，每月有 500 MB 免费存储，超出部分，每月每 GB 费用是 0.10 USD 。对于 Lambda 来说， ECR 的流量是免费的。</p>
</blockquote>
<p>上传容器镜像的过程如下：</p>
<ul>
<li>Authenticate the Docker CLI to your Amazon ECR registry.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 123456789012.dkr.ecr.us-east-1.amazonaws.com    
</code></pre></div><ul>
<li>Tag your image to match your repository name</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker tag  hello-world:latest 123456789012.dkr.ecr.us-east-1.amazonaws.com/hello-world:latest    
</code></pre></div><ul>
<li>deploy the image to Amazon ECR using the docker push command.</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker push 123456789012.dkr.ecr.us-east-1.amazonaws.com/hello-world:latest    
</code></pre></div><h4 id="本地测试镜像">本地测试镜像</h4>
<p>本地测试可以使用 AWS Lambda Runtime Interface Emulator （ RIE ）。 RIE 是 AWS Lambda Runtime API 代理，一个轻量的 Web Server ，可把 HTTP 请求转换为 JSON 事件，并传递给镜像中的 Lambda 函数。</p>
<ul>
<li>构建函数镜像</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker build -t myfunction:latest . 
</code></pre></div><ul>
<li>运行本地函数镜像</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">docker run -p 9000:8080  myfunction:latest
</code></pre></div><p>上述命令启动了一个 endpoint ，使用 POST 方法，设置请求 JSON ，调用该 API 。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">http://localhost:9000/2015-03-31/functions/function/invocations
</code></pre></div><h3 id="zip-文件">.zip 文件</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">zip <span style="color:#66d9ef">function</span>.zip main
</code></pre></div><h3 id="容器镜像或-zip-文件的部署">容器镜像或 .zip 文件的部署</h3>
<p>使用 AWS CLI 创建/更新 Lambda 函数，通过参数指定函数代码的来源：</p>
<ul>
<li>&ndash;code S3 bucket 或 ECR image url</li>
<li>&ndash;zip-file 本地上传的 zip 文件</li>
</ul>
<h2 id="lambda-函数环境变量">Lambda 函数环境变量</h2>
<p>可在 Lambda console 中设置，也可以通过 AWS CLI 或 AWS SDK 进行设置。</p>
<blockquote>
<p>所有环境变量大小总计不超过 4 KB</p>
</blockquote>
<h2 id="lambda-函数调用">Lambda 函数调用</h2>
<h3 id="同步调用">同步调用</h3>
<p>使用 AWS CLI 或某种语言（目前支持 Go，Java，C#，Ruby，Python，Node.js，PowerShell）的 SDK 可以<strong>发起</strong>同步调用。值得注意的是，最终触发 Lambda 函数的事件仍然是由下列 AWS 服务完成的：</p>
<ul>
<li>弹性负载均衡（Elastic Load Balancing）
<ul>
<li>该服务支持把 Lambda 作为应用负载均衡器（Application Load Balancer）的目标</li>
</ul>
</li>
<li>Amazon Cognito</li>
<li>Amazon Lex</li>
<li>Amazon Alexa</li>
<li>Amazon API Gateway</li>
<li>Amazon CloudFront ( Lambda@Edge )</li>
<li>Amazon Kinesis Data Firehose</li>
</ul>
<h4 id="关于弹性负载均衡">关于弹性负载均衡</h4>
<p>弹性负载均衡（Elastic Load Balancing）服务属于联网和内容分发服务大类，该服务可以转发流量至可用区内的各类目标，例如，EC2 实例，容器，IP 地址。它会监控目标的健康状况，并把流量转发至健康的目标。弹性负载均衡还会根据流量变化来对<strong>负载均衡器</strong>进行自动伸缩。</p>
<p>弹性负载均衡服务支持下列负载均衡器：</p>
<ul>
<li>应用负载均衡器（Application Load Balancer）</li>
<li>网络负载均衡器（Network Load Balancer）</li>
<li>网关负载均衡器（Gateway Load Balancer）</li>
<li>传统负载均衡器（Classic Load Balancer）</li>
</ul>
<h4 id="关于负载均衡器">关于负载均衡器</h4>
<p>负载均衡器（Load Balancer）为客户端提供一个单点服务，流量分发对客户端来说是透明的。</p>
<p>负载均衡器包含一个或多个监听器（listener）。监听器通过配置的协议和端口接收来自客户端的请求，而定义在监听器上的规则（rule）则决定了如何把请求路由到已注册的目标。每个规则都由优先级、条件、以及活动组成。当条件满足时，执行相应的活动。</p>
<h4 id="关于应用负载均衡器">关于应用负载均衡器</h4>
<p>应用负载均衡器（Application Load Balancer）</p>
<h3 id="异步调用">异步调用</h3>
<h2 id="aws-lambda-配额">AWS Lambda 配额</h2>
<p><a href="https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-limits.html">https://docs.aws.amazon.com/lambda/latest/dg/gettingstarted-limits.html</a></p>
<h2 id="aws-lambda-使用成本简析">AWS Lambda 使用成本简析</h2>
<p>AWS Lambda 使用成本由以下几项费用组成：</p>
<ul>
<li>AWS Lambda 基本费用</li>
<li>启用预配置并发产生的费用</li>
<li>数据传输产生的费用</li>
<li>启用 Lambda@Edge 产生的费用</li>
</ul>
<p>以上费用都是基于一些基础定价进行计算而得。这些基础定价又与多个因素相关，例如，可用区，为 Lambda 分配的内存量，调用 Lambda 的方式等等。下面在介绍各项费用时，会对相关的基础定价展开描述。</p>
<blockquote>
<p><em>注：一些优惠活动会节省 AWS Lambda 的使用成本，例如，AWS Lambda 免费使用套餐， Compute Savings Plans。</em></p>
</blockquote>
<h3 id="aws-lambda-基本费用">AWS Lambda 基本费用</h3>
<p>AWS Lambda 的基本费用由两个指标所产生的费用相加而成：</p>
<ul>
<li>请求数</li>
<li>执行时间</li>
</ul>
<blockquote>
<p><em>注：每当 Lambda 为响应事件通知或调用（包括控制台的测试调用）而开始执行时便记为一次请求。而持续时间是指从 Lambda 代码开始执行时算起直到其返回或以其他方式终止为止，舍入到最近的 1ms。</em></p>
</blockquote>
<p>以美国东部（俄亥俄）区域为例</p>
<table>
<thead>
<tr>
<th></th>
<th>基础价格</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>请求</strong></td>
<td>每 100 万个请求 0.20 USD</td>
</tr>
<tr>
<td><strong>持续时间</strong></td>
<td>每 GB 每秒 0.0000166667 USD</td>
</tr>
</tbody>
</table>
<blockquote>
<p><em>注：每 GB 每秒是指，当为 Lambda 分配了 1 GB （1024 MB）内存，Lambda 每运行 1 s，费用为 0.0000166667 USD。</em></p>
</blockquote>
<p>假设，部署了一个 Lambda 在美国东部（俄亥俄）区域，并为该 Lambda 分配了 10240 MB 内存。如果该 Lambda 某月响应了 100 万个请求，每个请求的平均持续时间为 100 ms，则该月的基本费用计算过程如下：</p>
<ol>
<li>请求数费用
<ul>
<li>1,000,000 requests x 0.0000002 USD = 0.20 USD (monthly request charges)</li>
</ul>
</li>
<li>持续时间费用
<ul>
<li>10240 MB x 0.0009765625 GB in a MB = 10 GB</li>
<li>1,000,000 requests x 100 ms x 0.001 ms to sec conversion factor = 100,000.00 total compute (seconds)</li>
<li>10 GB x 100,000.00 seconds = 1,000,000.00 total compute (GB-s)</li>
<li>1,000,000.00 GB-s x 0.0000166667 USD = 16.67 USD (monthly compute charges)</li>
</ul>
</li>
<li><strong>AWS Lambda 基本费用</strong>
<ul>
<li>16.67 USD + 0.20 USD = 16.87 USD</li>
</ul>
</li>
</ol>
<blockquote>
<p><em>注：AWS 提供了<a href="https://aws.amazon.com/lambda/pricing/">计算器</a>来辅助计算 Lambda 的基本费用。</em></p>
</blockquote>
<p>当参加一些优惠活动，以上费用会有所降低。例如，AWS Lambda 免费使用套餐包含每月 1M 次免费请求以及每月 400000GB-秒的计算时间。在这种情况下，上述场景中的请求数费用将被减免，持续时间费用会降低 40% 。免费套餐与区域政策有关。此外，如果承诺在 1 年或 3 年的期限内使用稳定数量的资源（以 USD/小时为单位衡量），可以注册适用于 AWS Lambda 的 Compute Saving Plans。注册后，承诺使用量将按 Savings Plans 费率收费，超出承诺的使用量将按常规的按需费率收费。</p>
<h3 id="启用预配置并发产生的费用">启用预配置并发产生的费用</h3>
<p>预配置并发可以使 Lambda 保持初始化状态，从而减少每次请求<strong>可能</strong>（在 Lambda 没有销毁的情况下，不必再次初始化）产生的初始化时间，从而提升无服务器应用程序的性能。</p>
<p>启用预配置并发产生的费用由三个指标所产生的费用相加而成：</p>
<ul>
<li>预配置并发</li>
<li>请求数</li>
<li>执行时间</li>
</ul>
<blockquote>
<p><em>注：预配置并发从在 Lambda 上启用时开始算起直至将其禁用，舍入到最近的 5 分钟。启用预配置并发通常是针对需要较长初始化时间的 Lambda，同时该 Lambda 正面临请求的高峰。</em></p>
</blockquote>
<p>以美国东部（俄亥俄）区域为例</p>
<table>
<thead>
<tr>
<th></th>
<th>基础价格</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>预配置并发</strong></td>
<td>每 GB 每秒 0.0000041667 USD</td>
</tr>
<tr>
<td><strong>请求</strong></td>
<td>每 100 万个请求 0.20 USD</td>
</tr>
<tr>
<td><strong>持续时间</strong></td>
<td>每 GB 每秒 0.0000097222 USD</td>
</tr>
</tbody>
</table>
<p>假设，当为 AWS Lambda 基本费用一节中的案例启用预配置并发 2 小时，并发数为1,000。也就是说，该 Lambda 被分配了 10240 MB 内存，在 2 小时内执行了 1 M 次，每次运行的时间为 100 ms。在这种情况下，将产生预配置并发费用。</p>
<ul>
<li>预配置并发为 0.000004167 USD/GB-s</li>
<li>预配置并发启用的总时长（秒）= 2 小时 = 7,200 秒</li>
<li>配置的总并发 (GB)：1000 * 1024MB/1024MB = 1000 GB</li>
<li>总预配置并发量 (GB-s) = 1000 GB * 7,200 秒 = 7.2M GB-s</li>
</ul>
<p>预配置并发费用 = 7.2M GB-s * 0.000004167 USD = 30 USD</p>
<p>请求与持续时间费用的计算方式与 AWS Lambda 基本费用一节中的案例相同。值得注意的是，当启用预配置并发时，持续时间的基础价格相比于未启用时要低一些。当然，加上预配置并发的费用，最终的基本费用将大大高于未启用的场景。</p>
<h3 id="数据传输产生的费用">数据传输产生的费用</h3>
<p>数据传输产生的费用与数据传输的场景相关：</p>
<ul>
<li>AWS Lambda 与相同区域内的服务进行数据传输
<ul>
<li>相互之间可免费进行数据传输的服务（请阅读下面的注）
<ul>
<li>Amazon S3</li>
<li>Amazon Glacier</li>
<li>Amazon DynamoDB</li>
<li>Amazon SES</li>
<li>Amazon SQS</li>
<li>Amazon Kinesis</li>
<li>Amazon ECR</li>
<li>Amazon SNS</li>
<li>Amazon EFS</li>
<li>Amazon SimpleDB</li>
</ul>
</li>
<li>除以上提及之外的服务与 AWS Lambda 进行数据传输产生的费用
<ul>
<li>弹性负载均衡（Elastic Load Balancing）</li>
<li>其他（请阅读下面的注）</li>
</ul>
</li>
<li>使用 AWS Lambda 进行 VPC 或 VPC 对等连接将产生额外费用</li>
</ul>
</li>
<li>AWS Lambda 与不同区域内的服务进行数据传输
<ul>
<li>参照 EC2 数据传输速率收费</li>
</ul>
</li>
</ul>
<blockquote>
<p><em>注：相同区域内可免费进行数据传输并不意味着没有费用产生，所免的只是数据传输费用！例如，当 Lambda 从 Amazon S3 读取数据，尽管数据传输是免费的，但对 Amazon S3 的读写请求是收费的，在 Amazon S3 中存储数据是收费的。</em></p>
</blockquote>
<blockquote>
<p><em>注：其他将产生费用的服务众多，例如，上述所有同步调用 Lambda 的服务，此处无法一一详述，仅以弹性负载均衡为例。事实上，弹性负载均衡服务产生的费用不仅包含数据传输费用，还包含了相关负载均衡器的运行费用。以下将一并说明。</em></p>
</blockquote>
<h4 id="弹性负载均衡产生的费用">弹性负载均衡产生的费用</h4>
<p>前文提到，弹性负载均衡服务提供了四种负载均衡器。不同的负载均衡器有不同的定价策略。本文以同步调用 Lambda 时使用的 Application Load Balancer 为例。</p>
<p>AWS 区域中的 Application Load Balancer 产生的费用由两个指标所产生的费用相加而成：</p>
<ul>
<li>每 Application Load Balancer 小时（或不足一小时）0.0225 USD</li>
<li>每 LCU 小时（或不足一小时）0.008 USD</li>
</ul>
<p>LCU 是指用于衡量 Application Load Balancer 处理流量时涉及的各个指标 (每小时平均值)。要衡量的四个指标包括：</p>
<ul>
<li>新连接数：每秒新建连接的数量。通常，每个连接可发送多个请求。</li>
<li>活跃连接数：每分钟内活跃连接的数量。</li>
<li>已处理的字节数：负载均衡器为 HTTP(S) 请求和响应处理的字节数（以 GB 为单位）。</li>
<li>规则评估数：指负载均衡器处理的规则数量与请求率的乘积。免费处理前 10 个规则（规则评估数 = 请求率 * (处理的规则数量 – 10 个免费规则)）</li>
</ul>
<p>在计算费用时，只需按使用量最高的指标付费即可。</p>
<p>一个 LCU 包括：</p>
<ul>
<li>每秒 25 个新连接。</li>
<li>每分钟 3000 个活跃连接。</li>
<li>EC2 实例、容器和 IP 地址作为目标时为每小时 1GB，Lambda 函数作为目标时为每小时 0.4 GB</li>
<li>每秒 1000 个规则评估</li>
</ul>
<p>假设，某个 Lambda 平均每秒接收 100 个新连接，并且每个连接持续 100 毫秒。客户端平均每秒发送 100 个请求，并且在连接的持续时间内 Lambda 请求和响应的已处理的字节数为 14 KB。此外，负载均衡器上配置了 20 个规则来路由客户端请求。如果使用 US-East-1 区域的定价来计算 Application Load Balancer 月度费用，具体如下：</p>
<ul>
<li>新连接数 (每秒)：
<ul>
<li>每个 LCU 每秒提供 25 个新连接 (每小时的平均值)。该 Lambda 每秒接收 100 个新连接，可换算为 4 个 LCU (每秒 100 个连接/每秒 25 个连接)</li>
</ul>
</li>
<li>活跃连接数 (每分钟)：
<ul>
<li>每个 LCU 每分钟提供 3000 个活跃连接。该 Lambda 每秒接收 100 个新连接，每个新连接持续 200 毫秒。这可换算为每分钟 100 个活跃连接，或 0.03 个 LCU (每分钟 100 个活跃连接/每分钟 3,000 个活跃连接)</li>
</ul>
</li>
<li>已处理的字节数（每小时的 GB 数）：
<ul>
<li>每个 LCU 每小时为 Lambda 流量提供 0.4 GB。每个客户端连接平均传输 14 KB 的数据，可换算成每小时 5.04 GB（每个请求 + 响应的 14 KB 的已处理的字节数 * 每秒 100 个请求 * 3600 秒）或每小时 12.6 个 LCU (5.04 GB/0.4 GB)。</li>
</ul>
</li>
<li>规则评估数 (每秒)：
<ul>
<li>简单起见，假设配置的所有规则均针对一个请求进行处理。每个 LCU 每秒提供 1000 个规则评估 (每小时的平均值)。该 Lambda 每秒接收 100 个请求，每个请求处理 20 个规则，则每秒最多会产生 1000 个规则评估（20 个处理的规则 – 10 个免费规则）* 100 或 1 个 LCU（每秒 1000 个规则评估/每秒 1000 个规则评估）。</li>
</ul>
</li>
</ul>
<p>在本示例中，LCU 使用率最高的维度是已处理字节数维度，因此，在费用计算中使用已处理字节数维度的 LCU 使用率。每小时 LCU 费用为 0.1008 USD（12.6 个 LCU * 每个 LCU 0.008）。加上每小时 0.0225 USD 的费用，Application Load Balancer 的总费用为：</p>
<ul>
<li>每小时 0.1233 USD (每小时 0.0225 USD 的费用 + 0.1008 USD 的 LCU 费用)；或</li>
<li>每月 88.78 USD (0.1233 USD * 24 小时 * 30 天)</li>
</ul>
<p>每秒 100 个请求可换算成每月 2.592 亿 (100<em>3600</em>24*30) 个请求。这可换算成每百万个请求 0.34 USD (88.78 USD/259.2)。</p>
<p><strong>简单来说，针对 AWS Lambda 基本费用一节中的案例，1 M 个请求，每次请求 14 KB 字节，弹性负载均衡服务每月产生的费用是 0.34 USD。</strong></p>
<h3 id="启用-lambdaedge-产生的费用">启用 Lambda@Edge 产生的费用</h3>
<p>Lambda@Edge 是 Amazon CloudFront 的一个功能，它可以让 Lambda 在靠近应用程序用户的地方运行，从而提高性能，降低延迟。Lambda@Edge 目前不提供免费套餐。Lambda@Edge 的基础价格如下：</p>
<p>以美国东部（俄亥俄）区域为例</p>
<table>
<thead>
<tr>
<th></th>
<th>基础价格</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>请求</strong></td>
<td>每 100 万个请求 0.60 USD</td>
</tr>
<tr>
<td><strong>持续时间</strong></td>
<td>每 GB 每秒 0.00005001 USD</td>
</tr>
</tbody>
</table>
<p>Lambda@Edge 所产生的费用，其计算过程与普通 Lambda 相同。Lambda@Edge 的基础价格相对较高，这是为获得低延迟高性能的应用所付出的成本。</p>
<p>总而言之，在本文所讨论的案例中，使用 Lambda 的总体费用每月小于 20 USD，却支持了 1 M 次请求，每次请求平均 14 KB 。这是一种性价比较高的方案选项。</p>
<ul class="pa0">
  
   <li class="list">
     <a href="/tags/%E8%BD%AF%E4%BB%B6" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">软件</a>
   </li>
  
   <li class="list">
     <a href="/tags/aws" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">AWS</a>
   </li>
  
   <li class="list">
     <a href="/tags/lambda" class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">Lambda</a>
   </li>
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l"><div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">这是什么 software</p>
      <nav id="TableOfContents">
  <ul>
    <li><a href="#简介">简介</a></li>
    <li><a href="#术语">术语</a></li>
    <li><a href="#常用命令-aws-cli">常用命令 AWS CLI</a></li>
    <li><a href="#lambda-运行环境">Lambda 运行环境</a></li>
    <li><a href="#lambda-运行环境生命周期">Lambda 运行环境生命周期</a></li>
    <li><a href="#lambda-函数发布">Lambda 函数发布</a>
      <ul>
        <li><a href="#容器镜像">容器镜像</a></li>
        <li><a href="#zip-文件">.zip 文件</a></li>
        <li><a href="#容器镜像或-zip-文件的部署">容器镜像或 .zip 文件的部署</a></li>
      </ul>
    </li>
    <li><a href="#lambda-函数环境变量">Lambda 函数环境变量</a></li>
    <li><a href="#lambda-函数调用">Lambda 函数调用</a>
      <ul>
        <li><a href="#同步调用">同步调用</a></li>
        <li><a href="#异步调用">异步调用</a></li>
      </ul>
    </li>
    <li><a href="#aws-lambda-配额">AWS Lambda 配额</a></li>
    <li><a href="#aws-lambda-使用成本简析">AWS Lambda 使用成本简析</a>
      <ul>
        <li><a href="#aws-lambda-基本费用">AWS Lambda 基本费用</a></li>
        <li><a href="#启用预配置并发产生的费用">启用预配置并发产生的费用</a></li>
        <li><a href="#数据传输产生的费用">数据传输产生的费用</a></li>
        <li><a href="#启用-lambdaedge-产生的费用">启用 Lambda@Edge 产生的费用</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>




  <div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
    <p class="f5 b mb3">相关內容</p>
    <ul class="pa0 list">
	   
	     <li  class="mb2">
          <a href="/software/product/flink/">Apache Flink</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/software/tool/rsa/">Rational Software Architect</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/software/theory/loadbalancing/">负载均衡</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/software/my/k8slocaldebug/">基于 kube-proxy userspace 代理模式下的本地调试</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/software/tool/docker/">Docker</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/software/tool/xlsx/">XLSX</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/software/tool/excelize/">Excelize</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/software/tool/git/">Git</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/software/tool/linuxcommand/">Linux 常用命令</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/software/language/go/">Go</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/software/product/envoy/">Envoy</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/software/product/gloo/">Gloo Edge</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/software/tool/make/">GNU make</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/software/tool/telepresence/">Telepresence</a>
        </li>
	    
	     <li  class="mb2">
          <a href="/software/env/installation/">软件开发工作环境搭建</a>
        </li>
	    
    </ul>
</div>

</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="http://nijian.life" >
    &copy;  一缕书香一缕魂 2021 
  </a>
    <div>














</div>
  </div>
</footer>

  </body>
</html>
